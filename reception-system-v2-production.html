<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kajo Reception System v2.0 - Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status { @apply px-2 py-1 rounded text-xs font-medium; }
        .status.pending { @apply bg-yellow-100 text-yellow-800; }
        .status.confirmed { @apply bg-blue-100 text-blue-800; }
        .status.checked_in { @apply bg-green-100 text-green-800; }
        .status.checked_out { @apply bg-purple-100 text-purple-800; }
        .status.completed { @apply bg-green-200 text-green-900; }
        .status.canceled { @apply bg-red-100 text-red-800; }
        .status.no_show { @apply bg-gray-100 text-gray-800; }
        .btn { @apply px-3 py-2 rounded font-medium transition-colors; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-success { @apply bg-green-600 text-white hover:bg-green-700; }
        .btn-purple { @apply bg-purple-600 text-white hover:bg-purple-700; }
        .btn-xs { @apply px-2 py-1 text-xs; }
        .btn:disabled { @apply opacity-50 cursor-not-allowed; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">üè• Kajo Reception System</h1>
                    <p class="text-gray-600">Production v2.0 - Edge Functions Integration</p>
                </div>
                <div class="flex items-center gap-2">
                    <span id="realtime-status" class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-sm">Connecting...</span>
                    <button id="refresh-btn" class="btn btn-primary">üîÑ Refresh</button>
                </div>
            </div>
        </div>

        <!-- Search & Filter Controls -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Phone Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√¨m theo SƒêT</label>
                    <input id="search-phone" type="text" placeholder="0123456789" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Date Range Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T·ª´ ng√†y</label>
                    <input id="filter-start" type="date" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·∫øn ng√†y</label>
                    <input id="filter-end" type="date"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col justify-end gap-2">
                    <button id="filter-apply" class="btn btn-primary">üìÖ √Åp d·ª•ng filter</button>
                    <div class="flex gap-2">
                        <button id="filter-today" class="btn bg-green-600 text-white text-xs">H√¥m nay</button>
                        <button id="filter-tomorrow" class="btn bg-blue-600 text-white text-xs">Ng√†y mai</button>
                        <button id="filter-week" class="btn bg-purple-600 text-white text-xs">7 ng√†y</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="text-2xl font-bold text-blue-600" id="stat-total">0</div>
                <div class="text-sm text-gray-600">T·ªïng s·ªë booking</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="text-2xl font-bold text-green-600" id="stat-checkedin">0</div>
                <div class="text-sm text-gray-600">ƒê√£ check-in</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="text-2xl font-bold text-purple-600" id="stat-checkedout">0</div>
                <div class="text-sm text-gray-600">ƒê√£ check-out</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="text-2xl font-bold text-yellow-600" id="stat-pending">0</div>
                <div class="text-sm text-gray-600">Ch·ªù x√°c nh·∫≠n</div>
            </div>
        </div>

        <!-- Bookings Table -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-900">üìã Danh s√°ch booking</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√£ booking</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kh√°ch h√†ng</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SƒêT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Th·ªùi gian</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tr·∫°ng th√°i</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="booking-table-body" class="divide-y divide-gray-200">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-results" class="p-8 text-center text-gray-500 hidden">
                üì≠ Kh√¥ng c√≥ booking n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <div>ƒêang x·ª≠ l√Ω...</div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        
        // ‚öôÔ∏è Configuration - UPDATE THESE VALUES
        const SUPABASE_URL = "https://vekrhqotmgszgsredkud.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla3JocW90bWdzemdzMmVka3VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU3Nzg5MTYsImV4cCI6MjA0MTM1NDkxNn0.IUVX8xUjqCiU8JGS3lxE30S2CQ_2R8FQp9f3TKP5WXw";
        const EDGE_BASE_URL = `${SUPABASE_URL}/functions/v1`;
        const EDGE_ADMIN_API_KEY = "kajo-admin-2025";
        
        // Initialize Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state
        let currentFilter = { phone: "", dateStart: "", dateEnd: "" };
        let allBookings = [];
        
        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function formatTime(timeStr) {
            if (!timeStr) return '';
            return timeStr.slice(0, 5);
        }
        
        function getTodayVN() {
            const vn = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" }));
            return `${vn.getFullYear()}-${String(vn.getMonth()+1).padStart(2,"0")}-${String(vn.getDate()).padStart(2,"0")}`;
        }
        
        function getTomorrowVN() {
            const vn = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" }));
            vn.setDate(vn.getDate() + 1);
            return `${vn.getFullYear()}-${String(vn.getMonth()+1).padStart(2,"0")}-${String(vn.getDate()).padStart(2,"0")}`;
        }
        
        function getWeekFromNowVN() {
            const vn = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" }));
            vn.setDate(vn.getDate() + 7);
            return `${vn.getFullYear()}-${String(vn.getMonth()+1).padStart(2,"0")}-${String(vn.getDate()).padStart(2,"0")}`;
        }
        
        // Database operations
        async function queryBookings() {
            try {
                let query = supabase
                    .from('bookings')
                    .select('*')
                    .order('appointment_date', { ascending: false })
                    .order('appointment_time', { ascending: true });
                
                if (currentFilter.phone) {
                    query = query.ilike('phone_number', `%${currentFilter.phone}%`);
                }
                
                if (currentFilter.dateStart) {
                    query = query.gte('appointment_date', currentFilter.dateStart);
                }
                
                if (currentFilter.dateEnd) {
                    query = query.lte('appointment_date', currentFilter.dateEnd);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('‚ùå Query error:', error);
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error('‚ùå Database error:', error);
                return [];
            }
        }
        
        async function reloadBookings() {
            try {
                showLoading(true);
                const data = await queryBookings();
                allBookings = data;
                renderTable(data);
                updateStats(data);
                
                if (data.length === 0) {
                    document.getElementById('no-results').classList.remove('hidden');
                } else {
                    document.getElementById('no-results').classList.add('hidden');
                }
            } catch (error) {
                console.error('‚ùå Error reloading bookings:', error);
            } finally {
                showLoading(false);
            }
        }
        
        // UI Operations
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
        
        function updateStats(bookings) {
            const stats = {
                total: bookings.length,
                checkedIn: bookings.filter(b => b.booking_status === 'checked_in').length,
                checkedOut: bookings.filter(b => b.booking_status === 'checked_out').length,
                pending: bookings.filter(b => ['pending', 'confirmed'].includes(b.booking_status)).length
            };
            
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-checkedin').textContent = stats.checkedIn;
            document.getElementById('stat-checkedout').textContent = stats.checkedOut;
            document.getElementById('stat-pending').textContent = stats.pending;
        }
        
        function renderTable(rows) {
            const tbody = document.querySelector('#booking-table-body');
            tbody.innerHTML = '';
            
            rows.forEach(row => {
                const canCheckIn = ['pending', 'confirmed'].includes(row.booking_status);
                const canCheckOut = row.booking_status === 'checked_in';
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-mono text-sm font-medium text-gray-900">
                            ${row.booking_code || '-'}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm font-medium text-gray-900">${row.customer_name || '-'}</div>
                        ${row.symptoms ? `<div class="text-xs text-gray-500">${row.symptoms}</div>` : ''}
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm text-gray-900">${row.phone_number || '-'}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm font-medium text-gray-900">
                            ${formatDate(row.appointment_date)} ${formatTime(row.appointment_time)}
                        </div>
                        ${row.checkin_timestamp ? `<div class="text-xs text-green-600">‚úì In: ${new Date(row.checkin_timestamp).toLocaleTimeString('vi-VN')}</div>` : ''}
                        ${row.checkout_timestamp ? `<div class="text-xs text-purple-600">‚úì Out: ${new Date(row.checkout_timestamp).toLocaleTimeString('vi-VN')}</div>` : ''}
                    </td>
                    <td class="px-4 py-3">
                        <span class="status ${row.booking_status}">${row.booking_status}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex gap-2">
                            <button class="btn btn-success btn-xs" ${canCheckIn ? '' : 'disabled'} 
                                    data-action="checkin" data-id="${row.id}">
                                üì• Check-in
                            </button>
                            <button class="btn btn-purple btn-xs" ${canCheckOut ? '' : 'disabled'} 
                                    data-action="checkout" data-id="${row.id}">
                                üì§ Check-out
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Edge Functions Integration
        async function callEdgeFunction(functionName, bookingId) {
            try {
                showLoading(true);
                
                const response = await fetch(`${EDGE_BASE_URL}/${functionName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-key': EDGE_ADMIN_API_KEY
                    },
                    body: JSON.stringify({ 
                        booking_id: bookingId, 
                        staff_id: 'reception-v2' 
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.ok) {
                    console.log(`‚úÖ ${functionName} successful:`, result);
                    
                    // Show success notification
                    const action = functionName === 'checkin' ? 'Check-in' : 'Check-out';
                    showNotification(`${action} th√†nh c√¥ng!`, 'success');
                    
                    // Reload data to reflect changes
                    await reloadBookings();
                } else {
                    console.error(`‚ùå ${functionName} failed:`, result);
                    showNotification(result.error || `${functionName} failed`, 'error');
                }
                
                return result;
            } catch (error) {
                console.error(`‚ùå Error calling ${functionName}:`, error);
                showNotification('C√≥ l·ªói x·∫£y ra khi th·ª±c hi·ªán thao t√°c', 'error');
                return { ok: false, error: error.message };
            } finally {
                showLoading(false);
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Real-time subscription
        function setupRealtime() {
            const statusEl = document.getElementById('realtime-status');
            
            supabase
                .channel('bookings-realtime')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'bookings' 
                }, (payload) => {
                    console.log('üì° Real-time update:', payload);
                    
                    const row = payload.new ?? payload.old;
                    if (matchesFilter(row)) {
                        reloadBookings();
                    }
                })
                .subscribe((status) => {
                    console.log('üì° Real-time subscription status:', status);
                    
                    switch (status) {
                        case 'SUBSCRIBED':
                            statusEl.textContent = 'üü¢ Real-time';
                            statusEl.className = 'px-2 py-1 bg-green-100 text-green-600 rounded text-sm';
                            break;
                        case 'CHANNEL_ERROR':
                        case 'TIMED_OUT':
                        case 'CLOSED':
                            statusEl.textContent = 'üî¥ Disconnected';
                            statusEl.className = 'px-2 py-1 bg-red-100 text-red-600 rounded text-sm';
                            break;
                        default:
                            statusEl.textContent = 'üü° Connecting...';
                            statusEl.className = 'px-2 py-1 bg-yellow-100 text-yellow-600 rounded text-sm';
                    }
                });
        }
        
        function matchesFilter(row) {
            if (!row) return false;
            
            if (currentFilter.phone && !String(row.phone_number || '').includes(currentFilter.phone)) {
                return false;
            }
            
            if (currentFilter.dateStart && row.appointment_date < currentFilter.dateStart) {
                return false;
            }
            
            if (currentFilter.dateEnd && row.appointment_date > currentFilter.dateEnd) {
                return false;
            }
            
            return true;
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize default date filters
            document.getElementById('filter-start').value = getTodayVN();
            document.getElementById('filter-end').value = getWeekFromNowVN();
            currentFilter.dateStart = getTodayVN();
            currentFilter.dateEnd = getWeekFromNowVN();
            
            // Setup real-time subscription
            setupRealtime();
            
            // Load initial data
            reloadBookings();
        });
        
        // Filter controls
        document.getElementById('filter-apply').addEventListener('click', () => {
            currentFilter.phone = document.getElementById('search-phone').value.trim();
            currentFilter.dateStart = document.getElementById('filter-start').value || "";
            currentFilter.dateEnd = document.getElementById('filter-end').value || "";
            reloadBookings();
        });
        
        document.getElementById('filter-today').addEventListener('click', () => {
            const today = getTodayVN();
            document.getElementById('filter-start').value = today;
            document.getElementById('filter-end').value = today;
            currentFilter.dateStart = today;
            currentFilter.dateEnd = today;
            reloadBookings();
        });
        
        document.getElementById('filter-tomorrow').addEventListener('click', () => {
            const tomorrow = getTomorrowVN();
            document.getElementById('filter-start').value = tomorrow;
            document.getElementById('filter-end').value = tomorrow;
            currentFilter.dateStart = tomorrow;
            currentFilter.dateEnd = tomorrow;
            reloadBookings();
        });
        
        document.getElementById('filter-week').addEventListener('click', () => {
            const today = getTodayVN();
            const week = getWeekFromNowVN();
            document.getElementById('filter-start').value = today;
            document.getElementById('filter-end').value = week;
            currentFilter.dateStart = today;
            currentFilter.dateEnd = week;
            reloadBookings();
        });
        
        document.getElementById('refresh-btn').addEventListener('click', () => {
            reloadBookings();
        });
        
        // Phone search on Enter
        document.getElementById('search-phone').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('filter-apply').click();
            }
        });
        
        // Action buttons
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            
            const id = btn.getAttribute('data-id');
            const action = btn.getAttribute('data-action');
            
            if (action === 'checkin') {
                await callEdgeFunction('checkin', id);
            } else if (action === 'checkout') {
                await callEdgeFunction('checkout', id);
            }
        });
    </script>
</body>
</html>
