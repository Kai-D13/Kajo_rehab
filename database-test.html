<!DOCTYPE html>
<html>
<head>
    <title>Database Connection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîç Supabase Database Test</h1>
    <button onclick="testConnection()">Test Database Connection</button>
    <div id="results"></div>

    <script>
        // Supabase config - CORRECT KEYS
        const SUPABASE_URL = 'https://vekrhqotmgszgsredkud.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla3JocW90bWdzemdzcmVka3VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzI1NTYsImV4cCI6MjA3MTUwODU1Nn0.KdUmhaSVPfWOEVgJ4C9Ybc0-IxO_Xs6mp8KUlYE_8cQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function testConnection() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ Testing connection...</p>';

            try {
                console.log('üîç Testing Database Connection...');
                
                // Test 1: Basic connection
                console.log('üì° Test 1: Basic Connection');
                const { data: bookings, error: connectionError } = await supabase
                    .from('bookings')
                    .select('*')
                    .limit(5);

                if (connectionError) {
                    resultsDiv.innerHTML = `<p>‚ùå Connection failed: ${connectionError.message}</p>`;
                    console.error('‚ùå Connection failed:', connectionError);
                    return;
                }

                resultsDiv.innerHTML = `
                    <p>‚úÖ Database connected successfully!</p>
                    <p>üìä Found ${bookings.length} bookings</p>
                    <pre>${JSON.stringify(bookings, null, 2)}</pre>
                `;
                console.log('‚úÖ Database connected successfully');
                console.log('üìã Bookings:', bookings);

                // Test 2: Staff table
                console.log('üë• Test 2: Staff Table');
                const { data: staff, error: staffError } = await supabase
                    .from('staff')
                    .select('*');

                if (!staffError) {
                    resultsDiv.innerHTML += `
                        <p>‚úÖ Staff table accessible</p>
                        <p>üë§ Staff count: ${staff.length}</p>
                        <pre>${JSON.stringify(staff, null, 2)}</pre>
                    `;
                }

                // Test 4: Test stored procedure v·ªõi correct types
                console.log('‚öôÔ∏è Test 4: Stored Procedures');
                const { data: conflictResult, error: procError } = await supabase
                    .rpc('check_booking_conflict', {
                        p_date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Tomorrow as DATE
                        p_time: '09:00:00' // TIME format
                    });

                if (procError) {
                    resultsDiv.innerHTML += `<p>‚ùå Stored procedure error: ${procError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `
                        <p>‚úÖ Stored procedure accessible</p>
                        <p>üîç Conflict check result: ${conflictResult}</p>
                    `;
                }

                // Test 5: Create test booking v·ªõi correct date/time types
                // Test 5: Create test booking v·ªõi correct date/time types
                console.log('üìù Test 5: Create Test Booking v·ªõi proper types');
                const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000);
                const testBooking = {
                    customer_name: 'Test Customer - Web',
                    phone_number: '0987654321',
                    appointment_date: tomorrow.toISOString().split('T')[0], // Format: YYYY-MM-DD
                    appointment_time: '15:00:00', // Format: HH:MM:SS
                    symptoms: 'Test symptoms from web interface',
                    booking_status: 'pending'
                };

                const { data: newBooking, error: createError } = await supabase
                    .from('bookings')
                    .insert([testBooking])
                    .select();

                if (createError) {
                    resultsDiv.innerHTML += `<p>‚ùå Booking creation failed: ${createError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `
                        <p>‚úÖ Test booking created successfully!</p>
                        <pre>${JSON.stringify(newBooking[0], null, 2)}</pre>
                    `;

                    // Clean up test booking
                    await supabase
                        .from('bookings')
                        .delete()
                        .eq('id', newBooking[0].id);
                    
                    resultsDiv.innerHTML += '<p>üßπ Test booking cleaned up</p>';
                }

                resultsDiv.innerHTML += '<p>üéâ ALL TESTS COMPLETED!</p>';

            } catch (error) {
                resultsDiv.innerHTML = `<p>‚ùå Unexpected error: ${error.message}</p>`;
                console.error('‚ùå Unexpected error:', error);
            }
        }
    </script>
</body>
</html>
