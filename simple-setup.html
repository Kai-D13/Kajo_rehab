<!DOCTYPE html>
<html>
<head>
    <title>Simple Zalo OA Setup</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .step { background: #f0f8ff; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .code { background: #f8f9fa; padding: 8px; font-family: monospace; border-radius: 4px; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîß Simple Zalo OA Setup Guide</h1>

    <!-- Step 1: Fix API Keys -->
    <div class="step warning">
        <h2>üîë Step 1: Fix Supabase API Key</h2>
        <p><strong>Current Error:</strong> 401 Unauthorized - Invalid API key</p>
        <p><strong>Solution:</strong></p>
        <ol>
            <li>V√†o <a href="https://supabase.com/dashboard/project/vekrhqotmgszgsredkud/settings/api" target="_blank">Supabase API Settings</a></li>
            <li>Copy <strong>anon/public</strong> key</li>
            <li>Paste v√†o field d∆∞·ªõi ƒë√¢y:</li>
        </ol>
        <input type="text" id="supabase-key" placeholder="Paste Supabase anon key here..." style="width: 100%;">
        <button onclick="testDatabase()">Test Database Connection</button>
        <div id="db-result"></div>
    </div>

    <!-- Step 2: Zalo OA Manual Setup -->
    <div class="step">
        <h2>üì± Step 2: Zalo OA Access Token (Manual Method)</h2>
        <p><strong>OA Information:</strong></p>
        <div class="code">
            Official Account ID: 2339827548685253412<br>
            URL: https://zalo.me/2339827548685253412<br>
            Category: Y t·∫ø & D∆∞·ª£c ph·∫©m<br>
            Type: Verified Account
        </div>
        
        <p><strong>Manual Token Method:</strong></p>
        <ol>
            <li>V√†o <a href="https://developers.zalo.me/" target="_blank">Zalo Developer Console</a></li>
            <li>Ch·ªçn App v·ªõi ID: <strong>2403652688841115720</strong></li>
            <li>V√†o <strong>"Official Account"</strong> section</li>
            <li>T√¨m <strong>"Access Token"</strong> ho·∫∑c <strong>"Test Users"</strong></li>
            <li>Copy access token (c√≥ th·ªÉ l√† temporary token)</li>
        </ol>
        
        <input type="text" id="oa-token" placeholder="Paste OA Access Token here...">
        <button onclick="testOAToken()">Test OA Token</button>
        <div id="oa-result"></div>
    </div>

    <!-- Step 3: Alternative - Using Postman/cURL -->
    <div class="step">
        <h2>üîß Step 3: Alternative Method (cURL/Postman)</h2>
        <p>N·∫øu OAuth flow kh√¥ng work, c√≥ th·ªÉ d√πng cURL ƒë·ªÉ get token:</p>
        <div class="code">
            <strong>Request:</strong><br>
            POST https://oauth.zaloapp.com/v4/oa/access_token<br><br>
            <strong>Headers:</strong><br>
            secret_key: 1Yb5YMVFGwGB7J7mSR9C<br>
            Content-Type: application/x-www-form-urlencoded<br><br>
            <strong>Body:</strong><br>
            app_id=2403652688841115720<br>
            grant_type=client_credentials
        </div>
        <button onclick="tryDirectTokenRequest()">Try Direct Token Request</button>
        <div id="direct-result"></div>
    </div>

    <!-- Step 4: Complete System Test -->
    <div class="step success">
        <h2>üöÄ Step 4: Complete System Test</h2>
        <p>Khi c√≥ c·∫£ Database key v√† OA token:</p>
        <button onclick="testCompleteSystem()" disabled id="complete-test-btn">Test Complete System</button>
        <div id="complete-result"></div>
    </div>

    <script>
        let validDbKey = null;
        let validOaToken = null;

        // Test database connection
        async function testDatabase() {
            const key = document.getElementById('supabase-key').value.trim();
            const resultDiv = document.getElementById('db-result');
            
            if (!key) {
                resultDiv.innerHTML = '<p style="color: red;">Please enter Supabase anon key</p>';
                return;
            }

            try {
                resultDiv.innerHTML = '<p>üîÑ Testing database...</p>';
                
                const response = await fetch('https://vekrhqotmgszgsredkud.supabase.co/rest/v1/bookings?select=*&limit=1', {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <p style="color: green;">‚úÖ Database connection successful!</p>
                        <p>Found ${data.length} bookings</p>
                    `;
                    validDbKey = key;
                    checkCompleteSystem();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Database test failed: ${error.message}</p>`;
            }
        }

        // Test OA token
        async function testOAToken() {
            const token = document.getElementById('oa-token').value.trim();
            const resultDiv = document.getElementById('oa-result');
            
            if (!token) {
                resultDiv.innerHTML = '<p style="color: red;">Please enter OA access token</p>';
                return;
            }

            try {
                resultDiv.innerHTML = '<p>üîÑ Testing OA token...</p>';
                
                const response = await fetch('https://openapi.zalo.me/v3.0/oa/getoa', {
                    headers: {
                        'access_token': token,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.error === 0) {
                    resultDiv.innerHTML = `
                        <p style="color: green;">‚úÖ OA token valid!</p>
                        <p><strong>OA Name:</strong> ${data.data.name}</p>
                        <p><strong>OA ID:</strong> ${data.data.oa_id}</p>
                    `;
                    validOaToken = token;
                    checkCompleteSystem();
                } else {
                    throw new Error(`OA API Error: ${data.message}`);
                }

            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå OA token test failed: ${error.message}</p>`;
            }
        }

        // Try direct token request
        async function tryDirectTokenRequest() {
            const resultDiv = document.getElementById('direct-result');
            
            try {
                resultDiv.innerHTML = '<p>üîÑ Attempting direct token request...</p>';
                
                // This might fail due to CORS, but worth trying
                const response = await fetch('https://oauth.zaloapp.com/v4/oa/access_token', {
                    method: 'POST',
                    headers: {
                        'secret_key': '1Yb5YMVFGwGB7J7mSR9C',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: 'app_id=2403652688841115720&grant_type=client_credentials'
                });

                const data = await response.json();
                
                if (data.access_token) {
                    resultDiv.innerHTML = `
                        <p style="color: green;">‚úÖ Direct token request successful!</p>
                        <p>Auto-filling token field...</p>
                    `;
                    document.getElementById('oa-token').value = data.access_token;
                } else {
                    throw new Error(data.error_description || 'Direct request failed');
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <p style="color: orange;">‚ö†Ô∏è Direct request failed (expected due to CORS): ${error.message}</p>
                    <p>Please use manual token method from Zalo Developer Console.</p>
                `;
            }
        }

        // Check if both components are working
        function checkCompleteSystem() {
            const btn = document.getElementById('complete-test-btn');
            if (validDbKey && validOaToken) {
                btn.disabled = false;
                btn.style.background = '#28a745';
            }
        }

        // Test complete system
        async function testCompleteSystem() {
            const resultDiv = document.getElementById('complete-result');
            resultDiv.innerHTML = '<p>üöÄ Testing complete booking system...</p>';
            
            try {
                // 1. Test database booking creation
                const bookingData = {
                    customer_name: 'Test Patient - System Test',
                    phone_number: '0987654321',
                    appointment_date: '2025-09-02',
                    appointment_time: '14:00:00',
                    symptoms: 'Complete system integration test',
                    booking_status: 'pending'
                };

                const dbResponse = await fetch('https://vekrhqotmgszgsredkud.supabase.co/rest/v1/bookings', {
                    method: 'POST',
                    headers: {
                        'apikey': validDbKey,
                        'Authorization': `Bearer ${validDbKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(bookingData)
                });

                if (!dbResponse.ok) {
                    throw new Error('Booking creation failed');
                }

                const booking = await dbResponse.json();

                resultDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
                        <h3>üéâ COMPLETE SYSTEM TEST SUCCESSFUL!</h3>
                        <p>‚úÖ Database connection: Working</p>
                        <p>‚úÖ Booking creation: Working</p>
                        <p>‚úÖ OA integration: Working</p>
                        <p><strong>Booking ID:</strong> ${booking[0].id}</p>
                        <p><strong>Status:</strong> ${booking[0].booking_status}</p>
                        <h4>üè• System Ready for Production!</h4>
                        <p><strong>Next Steps:</strong></p>
                        <ul>
                            <li>Update environment variables v·ªõi working keys</li>
                            <li>Deploy Mini App</li>
                            <li>Test end-to-end booking flow</li>
                        </ul>
                    </div>
                `;

                // Clean up test booking
                await fetch(`https://vekrhqotmgszgsredkud.supabase.co/rest/v1/bookings?id=eq.${booking[0].id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': validDbKey,
                        'Authorization': `Bearer ${validDbKey}`
                    }
                });

            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Complete system test failed: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
