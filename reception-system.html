<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kajo Reception System - Enhanced with Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .booking-card {
            transition: all 0.3s ease;
        }
        .booking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .confirmed { background: #fef3c7; color: #92400e; }
        .checked_in { background: #d1fae5; color: #065f46; }
        .checked_out { background: #e0e7ff; color: #3730a3; }
        .no_show { background: #fee2e2; color: #991b1b; }
        .cancelled { background: #fee2e2; color: #991b1b; }
        
        .booking-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            color: #1f2937;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .duration-badge {
            background: #f0fdf4;
            color: #166534;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-clinic-medical text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-xl font-semibold text-gray-900">Kajo Reception System</h1>
                    <span class="ml-3 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Enhanced v2.0</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="currentDateTime" class="text-sm text-gray-600"></span>
                    <div class="flex items-center space-x-2">
                        <div id="connectionStatus" class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">Real-time</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStatus('today')">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-calendar-check text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">H√¥m nay</p>
                        <p id="todayCount" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStatus('confirmed')">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Ch·ªù kh√°m</p>
                        <p id="confirmedCount" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStatus('checked_in')">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-check text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">ƒêang kh√°m</p>
                        <p id="checkedInCount" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStatus('checked_out')">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-purple-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Ho√†n th√†nh</p>
                        <p id="checkedOutCount" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStatus('no_show')">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-times text-red-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Kh√¥ng ƒë·∫øn</p>
                        <p id="noShowCount" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                    <!-- Date Range Filter -->
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-calendar text-gray-600"></i>
                        <label class="text-sm text-gray-600 font-medium">T·ª´:</label>
                        <input type="date" id="startDate" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <label class="text-sm text-gray-600 font-medium">ƒê·∫øn:</label>
                        <input type="date" id="endDate" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="applyDateRange()" class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search mr-1"></i>L·ªçc
                        </button>
                    </div>
                    
                    <!-- Quick Date Buttons -->
                    <div class="flex items-center space-x-2">
                        <button onclick="setQuickDate('today')" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-200 transition-colors text-sm">
                            H√¥m nay
                        </button>
                        <button onclick="setQuickDate('tomorrow')" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-200 transition-colors text-sm">
                            Ng√†y mai
                        </button>
                        <button onclick="setQuickDate('week')" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-200 transition-colors text-sm">
                            7 ng√†y
                        </button>
                    </div>
                    
                    <!-- Search by Phone -->
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-phone text-gray-600"></i>
                        <input type="text" id="phoneSearch" placeholder="T√¨m theo s·ªë ƒëi·ªán tho·∫°i..." 
                               class="border border-gray-300 rounded-md px-3 py-2 w-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Search by Booking Code -->
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-qrcode text-gray-600"></i>
                        <input type="text" id="codeSearch" placeholder="T√¨m theo m√£ booking..." 
                               class="border border-gray-300 rounded-md px-3 py-2 w-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="searchBookings()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>T√¨m
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button onclick="loadBookings()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>L√†m m·ªõi
                    </button>
                    <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-play mr-2"></i>Auto 30s
                    </button>
                </div>
            </div>
        </div>

        <!-- Bookings List -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Danh s√°ch l·ªãch h·∫πn</h2>
                <p class="text-sm text-gray-600 mt-1">Qu·∫£n l√Ω check-in/check-out v√† theo d√µi th·ªùi gian kh√°m</p>
            </div>
            
            <div id="loadingState" class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
            
            <div id="bookingsList" class="hidden">
                <div id="bookingsContainer" class="divide-y divide-gray-200">
                    <!-- Booking cards will be inserted here -->
                </div>
            </div>
            
            <div id="emptyState" class="hidden p-8 text-center">
                <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-600">Kh√¥ng c√≥ l·ªãch h·∫πn n√†o</p>
            </div>
        </div>
    </div>

    <!-- Check-in Modal -->
    <div id="checkinModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">X√°c nh·∫≠n check-in</h3>
                    <button onclick="closeModal('checkinModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="checkinContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeModal('checkinModal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                        H·ªßy
                    </button>
                    <button onclick="confirmCheckin()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Check-in
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Check-out Modal -->
    <div id="checkoutModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">X√°c nh·∫≠n check-out</h3>
                    <button onclick="closeModal('checkoutModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="checkoutContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ghi ch√∫ (t√πy ch·ªçn)</label>
                    <textarea id="checkoutNotes" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Th√™m ghi ch√∫ v·ªÅ bu·ªïi kh√°m..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeModal('checkoutModal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                        H·ªßy
                    </button>
                    <button onclick="confirmCheckout()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Check-out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded-md shadow-lg z-50 hidden">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <script>
        // Global variables
        let supabase = null;
        let currentBookingForAction = null;
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let allBookings = [];
        let currentFilter = 'all';
        let realtimeChannel = null;

        // Initialize Supabase with environment variables
        const supabaseUrl = 'https://vekrhqotmgszgsredkud.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla3JocW90bWdzemdzcmVka3VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzI1NTYsImV4cCI6MjA3MTUwODU1Nn0.KdUmhaSVPfWOEVgJ4C9Ybc0-IxO_Xs6mp8KUlYE_8cQ';
        const edgeBaseUrl = 'https://vekrhqotmgszgsredkud.supabase.co/functions/v1';
        const edgeAdminApiKey = supabaseAnonKey; // Use same key for now
        
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            console.log('‚úÖ Supabase client initialized');
            setupRealtimeSubscription();
        } catch (error) {
            console.error('‚ùå Failed to initialize Supabase:', error);
            updateConnectionStatus(false);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter').value = today;
            
            // Load initial data
            loadBookings();
            
            // Setup event listeners
            document.getElementById('dateFilter').addEventListener('change', loadBookings);
            
            // Setup search on Enter key
            document.getElementById('phoneSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchBookings();
            });
            document.getElementById('codeSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchBookings();
            });
        });

        function setupRealtimeSubscription() {
            try {
                realtimeChannel = supabase
                    .channel('bookings_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'bookings' }, 
                        (payload) => {
                            console.log('üì° Real-time update:', payload);
                            // Reload bookings when changes occur
                            setTimeout(loadBookings, 1000); // Small delay to ensure consistency
                        }
                    )
                    .subscribe((status) => {
                        console.log('üì° Real-time subscription status:', status);
                        updateConnectionStatus(status === 'SUBSCRIBED');
                    });
            } catch (error) {
                console.error('‚ùå Failed to setup real-time subscription:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(isConnected) {
            const statusIndicator = document.getElementById('connectionStatus');
            if (isConnected) {
                statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
            } else {
                statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('vi-VN', options);
        }

        async function loadBookings() {
            try {
                showLoading();
                const selectedDate = document.getElementById('dateFilter').value;
                
                console.log('üìÖ Loading bookings for date:', selectedDate);
                
                const { data, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .eq('appointment_date', selectedDate)
                    .order('appointment_time', { ascending: true });

                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    showError('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message);
                    return;
                }

                console.log('‚úÖ Loaded bookings:', data?.length || 0);
                allBookings = data || [];
                applyCurrentFilter();
                updateStats(data || []);
                
            } catch (error) {
                console.error('‚ùå Error loading bookings:', error);
                showError('L·ªói h·ªá th·ªëng: ' + error.message);
            }
        }

        function filterByStatus(status) {
            currentFilter = status;
            applyCurrentFilter();
        }

        function applyCurrentFilter() {
            let filteredBookings = allBookings;
            
            if (currentFilter === 'today') {
                const today = new Date().toISOString().split('T')[0];
                filteredBookings = allBookings.filter(b => b.appointment_date === today);
            } else if (currentFilter !== 'all') {
                filteredBookings = allBookings.filter(b => b.booking_status === currentFilter);
            }
            
            displayBookings(filteredBookings);
        }

        async function searchBookings() {
            const phoneNumber = document.getElementById('phoneSearch').value.trim();
            const bookingCode = document.getElementById('codeSearch').value.trim();
            
            if (!phoneNumber && !bookingCode) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ho·∫∑c m√£ booking', 'warning');
                return;
            }

            try {
                showLoading();
                let query = supabase.from('bookings').select('*');
                
                if (phoneNumber) {
                    query = query.eq('phone_number', phoneNumber);
                } else if (bookingCode) {
                    query = query.eq('booking_code', bookingCode.toUpperCase());
                }
                
                const { data, error } = await query.order('appointment_date', { ascending: false });

                if (error) {
                    console.error('‚ùå Search error:', error);
                    showError('L·ªói t√¨m ki·∫øm: ' + error.message);
                    return;
                }

                console.log('‚úÖ Found bookings:', data?.length || 0);
                allBookings = data || [];
                currentFilter = 'all';
                applyCurrentFilter();
                updateStats(data || []);
                
                if (data?.length === 0) {
                    showNotification('‚ÑπÔ∏è Kh√¥ng t√¨m th·∫•y booking n√†o', 'info');
                }
                
            } catch (error) {
                console.error('‚ùå Error searching:', error);
                showError('L·ªói t√¨m ki·∫øm: ' + error.message);
            }
        }

        function displayBookings(bookings) {
            const container = document.getElementById('bookingsContainer');
            const loadingState = document.getElementById('loadingState');
            const bookingsList = document.getElementById('bookingsList');
            const emptyState = document.getElementById('emptyState');

            loadingState.classList.add('hidden');

            if (bookings.length === 0) {
                bookingsList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            bookingsList.classList.remove('hidden');

            container.innerHTML = bookings.map(booking => createBookingCard(booking)).join('');
        }

        function createBookingCard(booking) {
            const statusInfo = getStatusInfo(booking.booking_status);
            const appointmentDateTime = new Date(`${booking.appointment_date}T${booking.appointment_time}`);
            const isToday = booking.appointment_date === new Date().toISOString().split('T')[0];
            
            // Calculate duration if both timestamps exist
            let durationDisplay = '';
            if (booking.checkin_timestamp && booking.checkout_timestamp) {
                const duration = calculateDuration(booking.checkin_timestamp, booking.checkout_timestamp);
                durationDisplay = `<span class="duration-badge">${duration}</span>`;
            }
            
            return `
                <div class="booking-card p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-3">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-user-circle text-3xl text-gray-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${booking.customer_name}</h3>
                                    <div class="flex items-center space-x-3">
                                        <p class="text-sm text-gray-600">
                                            <i class="fas fa-phone mr-1"></i>${booking.phone_number}
                                        </p>
                                        ${booking.booking_code ? `<span class="booking-code">${booking.booking_code}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex-shrink-0 flex items-center space-x-2">
                                    <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                                    ${durationDisplay}
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mb-3">
                                <div>
                                    <p class="text-gray-600">Th·ªùi gian kh√°m</p>
                                    <p class="font-medium ${isToday ? 'text-blue-600' : 'text-gray-900'}">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${formatDate(booking.appointment_date)} ${formatTime(booking.appointment_time)}
                                    </p>
                                </div>
                                
                                <div>
                                    <p class="text-gray-600">D·ªãch v·ª•</p>
                                    <p class="font-medium text-gray-900">
                                        <i class="fas fa-stethoscope mr-1"></i>
                                        ${booking.service_type || 'Ch∆∞a x√°c ƒë·ªãnh'}
                                    </p>
                                </div>
                                
                                <div>
                                    <p class="text-gray-600">Tri·ªáu ch·ª©ng</p>
                                    <p class="font-medium text-gray-900">
                                        ${booking.symptoms || 'Kh√¥ng c√≥'}
                                    </p>
                                </div>
                            </div>
                            
                            ${booking.checkin_timestamp ? `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded-md">
                                    <div>
                                        <p class="text-gray-600">Check-in l√∫c</p>
                                        <p class="font-medium text-green-600">${formatDateTime(booking.checkin_timestamp)}</p>
                                    </div>
                                    ${booking.checkout_timestamp ? `
                                        <div>
                                            <p class="text-gray-600">Check-out l√∫c</p>
                                            <p class="font-medium text-purple-600">${formatDateTime(booking.checkout_timestamp)}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${booking.detailed_description ? `
                                <div class="mt-3 p-3 bg-blue-50 rounded-md">
                                    <p class="text-sm text-gray-700">${booking.detailed_description}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex-shrink-0 ml-4 space-y-2">
                            ${getActionButtons(booking)}
                        </div>
                    </div>
                </div>
            `;
        }

        function getActionButtons(booking) {
            const status = booking.booking_status;
            
            switch (status) {
                case 'confirmed':
                    return `
                        <button onclick="openCheckinModal('${booking.id}')" 
                                class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-check mr-2"></i>Check-in
                        </button>
                    `;
                case 'checked_in':
                    return `
                        <button onclick="openCheckoutModal('${booking.id}')" 
                                class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Check-out
                        </button>
                    `;
                case 'checked_out':
                    return `
                        <div class="text-center">
                            <i class="fas fa-check-circle text-purple-600 text-2xl"></i>
                            <p class="text-sm text-purple-600 font-medium">Ho√†n th√†nh</p>
                        </div>
                    `;
                case 'no_show':
                    return `
                        <div class="text-center">
                            <i class="fas fa-user-times text-red-600 text-2xl"></i>
                            <p class="text-sm text-red-600 font-medium">Kh√¥ng ƒë·∫øn</p>
                        </div>
                    `;
                case 'cancelled':
                    return `
                        <div class="text-center">
                            <i class="fas fa-ban text-red-600 text-2xl"></i>
                            <p class="text-sm text-red-600 font-medium">ƒê√£ h·ªßy</p>
                        </div>
                    `;
                default:
                    return `
                        <div class="text-center">
                            <p class="text-sm text-gray-500">${status}</p>
                        </div>
                    `;
            }
        }

        function getStatusInfo(status) {
            switch (status) {
                case 'confirmed':
                    return { text: 'ƒê√£ x√°c nh·∫≠n', class: 'confirmed' };
                case 'checked_in':
                    return { text: 'ƒêang kh√°m', class: 'checked_in' };
                case 'checked_out':
                    return { text: 'Ho√†n th√†nh', class: 'checked_out' };
                case 'no_show':
                    return { text: 'Kh√¥ng ƒë·∫øn', class: 'no_show' };
                case 'cancelled':
                    return { text: 'ƒê√£ h·ªßy', class: 'cancelled' };
                default:
                    return { text: status || 'Kh√¥ng x√°c ƒë·ªãnh', class: 'confirmed' };
            }
        }

        function updateStats(bookings) {
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = bookings.filter(b => b.appointment_date === today);
            
            document.getElementById('todayCount').textContent = todayBookings.length;
            document.getElementById('confirmedCount').textContent = bookings.filter(b => b.booking_status === 'confirmed').length;
            document.getElementById('checkedInCount').textContent = bookings.filter(b => b.booking_status === 'checked_in').length;
            document.getElementById('checkedOutCount').textContent = bookings.filter(b => b.booking_status === 'checked_out').length;
            document.getElementById('noShowCount').textContent = bookings.filter(b => b.booking_status === 'no_show').length;
        }

        async function openCheckinModal(bookingId) {
            try {
                const booking = allBookings.find(b => b.id === bookingId);
                if (!booking) {
                    showNotification('‚ùå Kh√¥ng t√¨m th·∫•y booking', 'error');
                    return;
                }

                currentBookingForAction = booking;
                
                document.getElementById('checkinContent').innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <p class="font-semibold">${booking.customer_name}</p>
                            <p class="text-sm text-gray-600">${booking.phone_number}</p>
                            ${booking.booking_code ? `<p class="booking-code mt-1">${booking.booking_code}</p>` : ''}
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Th·ªùi gian kh√°m</p>
                            <p class="font-medium">${formatDate(booking.appointment_date)} ${formatTime(booking.appointment_time)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">D·ªãch v·ª•</p>
                            <p class="font-medium">${booking.service_type || 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('checkinModal').classList.remove('hidden');
            } catch (error) {
                console.error('‚ùå Error in openCheckinModal:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        async function openCheckoutModal(bookingId) {
            try {
                const booking = allBookings.find(b => b.id === bookingId);
                if (!booking) {
                    showNotification('‚ùå Kh√¥ng t√¨m th·∫•y booking', 'error');
                    return;
                }

                currentBookingForAction = booking;
                
                const checkinTime = booking.checkin_timestamp ? new Date(booking.checkin_timestamp) : null;
                const currentTime = new Date();
                const currentDuration = checkinTime ? calculateDuration(booking.checkin_timestamp, currentTime.toISOString()) : 'N/A';
                
                document.getElementById('checkoutContent').innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <p class="font-semibold">${booking.customer_name}</p>
                            <p class="text-sm text-gray-600">${booking.phone_number}</p>
                            ${booking.booking_code ? `<p class="booking-code mt-1">${booking.booking_code}</p>` : ''}
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Check-in l√∫c</p>
                            <p class="font-medium text-green-600">${formatDateTime(booking.checkin_timestamp)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Th·ªùi gian kh√°m hi·ªán t·∫°i</p>
                            <p class="font-medium text-blue-600">${currentDuration}</p>
                        </div>
                    </div>
                `;
                
                // Clear previous notes
                document.getElementById('checkoutNotes').value = '';
                document.getElementById('checkoutModal').classList.remove('hidden');
            } catch (error) {
                console.error('‚ùå Error in openCheckoutModal:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            currentBookingForAction = null;
        }

        async function confirmCheckin() {
            if (!currentBookingForAction) return;

            try {
                console.log('üîÑ Calling Edge Function for checkin:', currentBookingForAction.id);

                const response = await fetch(`${edgeBaseUrl}/checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${edgeAdminApiKey}`,
                        'x-admin-key': edgeAdminApiKey
                    },
                    body: JSON.stringify({ 
                        booking_id: currentBookingForAction.id,
                        booking_code: currentBookingForAction.booking_code,
                        staff_id: 'reception-01',
                        notes: document.getElementById('checkinNotes')?.value || ''
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    console.error('‚ùå Checkin Edge Function failed:', result);
                    showNotification('‚ùå L·ªói check-in: ' + (result.error || result.message || 'Unknown error'), 'error');
                    return;
                }

                console.log('‚úÖ Checkin successful via Edge Function:', result);
                closeModal('checkinModal');
                showNotification(`‚úÖ Check-in th√†nh c√¥ng cho ${currentBookingForAction.customer_name}`, 'success');
                
                // Real-time will handle the update, but reload to be sure
                setTimeout(loadBookings, 1000);
                
            } catch (error) {
                console.error('‚ùå Checkin error:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        async function confirmCheckout() {
            if (!currentBookingForAction) return;

            try {
                const notes = document.getElementById('checkoutNotes').value.trim();
                
                console.log('üîÑ Calling Edge Function for checkout:', currentBookingForAction.id);

                const response = await fetch(`${edgeBaseUrl}/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${edgeAdminApiKey}`,
                        'x-admin-key': edgeAdminApiKey
                    },
                    body: JSON.stringify({ 
                        booking_id: currentBookingForAction.id,
                        booking_code: currentBookingForAction.booking_code,
                        staff_id: 'reception-01',
                        notes: notes,
                        billing_amount: null, // Add if needed
                        payment_method: null  // Add if needed
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    console.error('‚ùå Checkout Edge Function failed:', result);
                    showNotification('‚ùå L·ªói check-out: ' + (result.error || result.message || 'Unknown error'), 'error');
                    return;
                }

                console.log('‚úÖ Checkout successful via Edge Function:', result);
                closeModal('checkoutModal');
                
                // Calculate final duration if available
                const duration = currentBookingForAction.checkin_timestamp ? 
                    calculateDuration(currentBookingForAction.checkin_timestamp, new Date().toISOString()) : 'N/A';
                showNotification(`‚úÖ Check-out th√†nh c√¥ng cho ${currentBookingForAction.customer_name} (Th·ªùi gian kh√°m: ${duration})`, 'success');
                
                // Real-time will handle the update, but reload to be sure
                setTimeout(loadBookings, 1000);
                
            } catch (error) {
                console.error('‚ùå Checkout error:', error);
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }
                showNotification(`‚úÖ Check-out th√†nh c√¥ng cho ${currentBookingForAction.customer_name} (Th·ªùi gian kh√°m: ${duration})`, 'success');
                
                // Don't reload immediately as real-time will handle it
                
            } catch (error) {
                showNotification('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>Auto 30s';
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                autoRefreshInterval = setInterval(loadBookings, 30000); // 30 seconds
                isAutoRefresh = true;
                btn.innerHTML = '<i class="fas fa-stop mr-2"></i>D·ª´ng auto';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('bookingsList').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function showError(message) {
            const container = document.getElementById('bookingsContainer');
            container.innerHTML = `
                <div class="p-8 text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                    <p class="text-red-600">${message}</p>
                </div>
            `;
            
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('bookingsList').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notificationToast');
            const messageElement = document.getElementById('notificationMessage');
            
            messageElement.textContent = message;
            
            // Set color based on type
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-md shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 
                type === 'info' ? 'bg-blue-600' : 'bg-green-600'
            } text-white`;
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 4000);
        }

        function calculateDuration(startTime, endTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end.getTime() - start.getTime();
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('vi-VN');
        }

        function formatTime(timeString) {
            return timeString.substring(0, 5);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('vi-VN');
        }

        // Date Range Filter Functions
        function setQuickDate(period) {
            const today = new Date();
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            switch(period) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    startDate.value = todayStr;
                    endDate.value = todayStr;
                    break;
                case 'tomorrow':
                    const tomorrow = new Date(today);
                    tomorrow.setDate(today.getDate() + 1);
                    const tomorrowStr = tomorrow.toISOString().split('T')[0];
                    startDate.value = tomorrowStr;
                    endDate.value = tomorrowStr;
                    break;
                case 'week':
                    const weekEnd = new Date(today);
                    weekEnd.setDate(today.getDate() + 6);
                    startDate.value = today.toISOString().split('T')[0];
                    endDate.value = weekEnd.toISOString().split('T')[0];
                    break;
            }
            
            // Auto apply filter after setting dates
            applyDateRange();
        }

        async function applyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('‚ö†Ô∏è Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c', 'warning');
                return;
            }
            
            if (startDate > endDate) {
                showNotification('‚ö†Ô∏è Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c sau ng√†y k·∫øt th√∫c', 'warning');
                return;
            }
            
            console.log(`üìÖ Loading bookings from ${startDate} to ${endDate}`);
            
            try {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('bookingsList').classList.add('hidden');
                
                const { data: bookings, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .gte('appointment_date', startDate)
                    .lte('appointment_date', endDate)
                    .order('appointment_date', { ascending: true })
                    .order('appointment_time', { ascending: true });

                if (error) {
                    throw error;
                }

                console.log(`‚úÖ Loaded ${bookings.length} bookings for date range`);
                allBookings = bookings;
                displayBookings(allBookings);
                updateStatistics(allBookings);
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('bookingsList').classList.remove('hidden');
                
                showNotification(`‚úÖ T√¨m th·∫•y ${bookings.length} l·ªãch h·∫πn t·ª´ ${formatDate(startDate)} ƒë·∫øn ${formatDate(endDate)}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error loading date range:', error);
                showNotification('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('bookingsList').classList.remove('hidden');
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>